!function(){var a=this;return a.music=document.getElementById("audio"),a.muted=$.cookie("muted")?!0:!1,a.nickname=$.cookie("nickname"),a.frames++,a.started=!1,a.overlay=!1,a.startedAt=0,a.cell=20,a.width=0,a.height=0,a.$container=null,a.$entities=null,a.uid=null,a.scene={length:10,types:["tree","stone"]},a.directions=[{x:-1,y:0,direction:"left"},{x:0,y:1,direction:"bottom"},{x:1,y:0,direction:"right"},{x:0,y:-1,direction:"top"}],a.lastdirection=3,a.direction=3,a.anaconda=null,a.victim=null,a.init=function(){return a.muted&&$("#music").addClass("disabled"),a.$container=$("#game"),a.$entities=a.$container.find("#entities"),a.prepare(),a.controls(),$.cookie("unique")||$.cookie("unique",random_str(16),{path:"/",expires:3650}),a.uid=$.cookie("unique"),a},a.controls=function(){return a.$container.on("click",function(){a.started||a.startGame()}),a.$container.find(".overlay").on("click",function(a){a.stopPropagation()}),$(".replay").on("click",function(){a.started||window.location.reload()}),$("#music").on("click",function(){a.muted=!a.muted,a.muted?(a.music.pause(),$(this).addClass("disabled")):($(this).removeClass("disabled"),a.started&&a.music.play()),$.cookie("muted",a.muted?1:0,{path:"/",expires:3650})}),$("a.share-facebook").on("click",function(a){a.preventDefault(),window.open("https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent("http://sneakyben.fr/"),"","status=0,toolbar=0,height=250,width=600")}),$("a.share-twitter").on("click",function(b){b.preventDefault();var c="I just got rekt, in approximately "+a.score/1e3+" seconds. Can you do better? #SneakyBen #iim bit.ly/1Dc7Mg9",d="I did it in "+a.score/1e3+" seconds! Can you do better? #SneakyBen #iim bit.ly/1Dc7Mg9",e=$(this).closest(".overlay").attr("id");return window.open("https://twitter.com/home?status="+encodeURIComponent("win"==e?d:c),"","status=0,toolbar=0,height=250,width=600"),console.log("test"),!1}),$("a.share-google").on("click",function(a){a.preventDefault(),window.open("https://plus.google.com/share?url="+encodeURIComponent("http://sneakyben.fr/"),"","status=0,toolbar=0,height=500,width=520")}),$("a.share-pinterest").on("click",function(a){a.preventDefault(),alert("do people actually use that thing ?")}),a.dom=setInterval(function(){$("[data-ago]").each(function(){$(this).html(moment.utc($(this).data("ago")).fromNow())})},5e3),$(window).keydown(function(b){switch(b.which){case 37:2!=a.direction&&(a.direction=0),b.preventDefault();break;case 38:1!=a.direction&&(a.direction=3),b.preventDefault();break;case 39:0!=a.direction&&(a.direction=2),b.preventDefault();break;case 40:3!=a.direction&&(a.direction=1),b.preventDefault()}a.started||a.overlay||a.startGame()}),a},a.startGame=function(){a.$container.removeClass("waiting win lose intensify").addClass("started"),a.frames=0,a.started=!0,a.startedAt=+new Date,requestAnimFrame(a.render),a.interval=setInterval(a.render,60),!a.muted&&a.music.play(),$("html, body").animate({scrollTop:$("#game").offset().top-15},500)},a.endGame=function(){a.started=!1,clearInterval(a.interval),a.$container.removeClass("started"),a.music.pause(),a.music.currentTime=0},a.prepare=function(){a.started||(a.builtContainer(),a.anaconda=new a.Anaconda,a.generateScenery(),a.victim=new a.Victim)},a.win=function(){if(a.started){if(a.endGame(),a.$container.addClass("win"),a.score=+new Date-a.startedAt,a.overlay=!0,$("#win").show(),$({v:0}).animate({v:a.score/1e3},{duration:2e3,easing:"easeOutExpo",step:function(){$("#win .score").text(this.v.toFixed(2))},complete:function(){$("#win .score").text((a.score/1e3).toFixed(2))}}),$("#win video").get(0).play(),!a.nickname){var b=prompt("Holy moley ! you just got an highscore... can you belive it?!","Your nickname goes here");null!=b?($.cookie("nickname",b,{path:"/",expires:3650}),a.nickname=$.cookie("nickname")):alert("No highscore for you sir")}a.nickname&&a.share(a.score)}},a.lose=function(){a.started&&(a.endGame(),a.overlay=!0,a.$container.addClass("intensify"),setTimeout(function(){a.$container.addClass("lose"),a.score=+new Date-a.startedAt,$("#lose").show(),$({v:0}).animate({v:a.score/1e3},{duration:2e3,easing:"easeOutExpo",step:function(){$("#lose .score").text(this.v.toFixed(2))},complete:function(){$("#lose .score").text((a.score/1e3).toFixed(2))}}),$("#lose video").get(0).play()},3e3))},a.share=function(b){$.ajax({data:{score:b,nickname:a.nickname},type:"post",url:"./score"}).done(function(){})},a.builtContainer=function(){a.$entities.html(""),a.$container.css({width:"auto"}),a.width=Math.floor(Math.max(320,a.$container.width())/a.cell),a.height=Math.floor((Math.max(420,$(window).height())-15)/a.cell),a.$container.width(a.width*a.cell),a.$container.height(a.height*a.cell),a.entities=[];for(var b=0;b<a.width;b++){a.entities[b]=[];for(var c=0;c<a.height;c++)a.entities[b][c]=null}},a.generateScenery=function(){for(var b=a.width*a.height,c=random_num(2,b/20,!0),d=random_num(2,b/50,!0),e=["tree1","tree2","bush1","bush2","cactus1","cactus2"],f=0;c>f;f++){var g=a.getEmpty();new a.Entity({x:g.x,y:g.y,style:{zIndex:100*g.y+g.x},name:"tree","class":e[Math.floor(Math.random()*e.length)]+(Math.random()>.5?" flipped":"")})}for(var f=0;d>f;f++){var g=a.getEmpty();new a.Entity({x:g.x,y:g.y,style:{zIndex:100*g.y+g.x},name:"stone","class":Math.random()>.5?"flipped":null});for(var h=0;h<random_num(0,30);h++){var i=a.getNearest(g.x,g.y);if(!i)break;new a.Entity({x:i.x,y:i.y,style:{zIndex:100*i.y+i.x},name:"stone","class":Math.random()>.5?"flipped":null}),g=i}}},a.getValue=function(b,c){return b>=0&&c>=0&&"undefined"!=typeof a.entities[b]&&"undefined"!=typeof a.entities[b][c]&&a.entities[b][c]},a.getEmpty=function(){for(var b=null,c=null,d=0;(null==b&&null==c||null!==a.entities[b][c])&&++d!==a.width*a.height;)b=random_num(0,a.width-1,!0),c=random_num(0,a.height-1,!0);return d===a.width*a.height?null:{x:b,y:c}},a.getNearest=function(b,c,d,e,f){for(var f=f||[],g={x:b,y:c},h={},i=e?e:shuffle(a.directions.slice()),j=0;4>j;j++)if(h.x=g.x+i[j].x,h.y=g.y+i[j].y,h.direction=i[j].direction,!(d&&h.direction===d||a.getValue(h.x,h.y)===!1||null!==a.entities[h.x][h.y]||f[h.x+"-"+h.y]))return h;return!1},a.Entity=function(b){var c=this;return c.x=b.x,c.y=b.y,c.name=b.name||null,c.container=b.container||null,c.$class=b.class||null,c.$cell=null,c.$sprite=b.sprite||null,c.style=b.style||null,c.init=function(){if("undefined"==typeof b.x||"undefined"==typeof b.y){var d=a.getEmpty();c.x=d.x,c.y=d.y}return c.container&&!a.$entities.find(".group."+c.container).length&&a.$entities.append($("<div/>",{"class":"group "+c.container})),c.$cell=$("<div/>",{"class":"entity"+(c.name?" "+c.name:"")+(c.$class?" "+c.$class:"")}).html($("<div/>",{"class":"sprite"}).html(c.$sprite?c.$sprite:"")).css({top:c.y*a.cell,left:c.x*a.cell,width:a.cell,height:a.cell}),c.style&&c.$cell.css(c.style),c.$sprite=c.$cell.find(".sprite"),a.entities[c.x][c.y]=c,c.container?a.$entities.find(".group."+c.container).append(c.$cell):a.$entities.append(c.$cell),c},c.move=function(b,d){"undefined"!=typeof b&&"undefined"!=typeof d&&a.getValue(b,d)!==!1&&(a.entities[c.x][c.y]=null,c.x=b,c.y=d,a.entities[c.x][c.y]=c,c.$cell.css({top:c.y*a.cell,left:c.x*a.cell,zIndex:100*c.y+50+c.x}))},c.remove=function(){c.$cell.remove(),a.entities[c.x][c.y]=null,delete c},c.init()},a.Victim=function(){var c=this;return c.entity=null,c.nope=[],c.init=function(){var b={x:random_num(2*(a.width/3),a.width,!0),y:random_num(0,a.height,!0)};return c.entity=new a.Entity({x:b.x,y:b.y,name:"victim","class":"stickman"}),c},c.move=function(){var b=a.anaconda.parts[0];({x:Math.abs(b.x-c.entity.x),y:Math.abs(b.y-c.entity.y)}),Math.sqrt(Math.pow(b.x-c.entity.x,2)+Math.pow(b.y-c.entity.y,2));var h=[];h.push({direction:0,distance:Math.sqrt(Math.pow(b.x-(c.entity.x-1),2)+Math.pow(b.y-c.entity.y,2))}),h.push({direction:1,distance:Math.sqrt(Math.pow(b.x-c.entity.x,2)+Math.pow(b.y-(c.entity.y+1),2))}),h.push({direction:2,distance:Math.sqrt(Math.pow(b.x-(c.entity.x+1),2)+Math.pow(b.y-c.entity.y,2))}),h.push({direction:3,distance:Math.sqrt(Math.pow(b.x-c.entity.x,2)+Math.pow(b.y-(c.entity.y-1),2))}),h.sort(function(a,b){return b.distance-a.distance});var i=[];h.forEach(function(b){i.push(a.directions[b.direction])});var j=a.getNearest(c.entity.x,c.entity.y,null,i,c.nope);a.isCulDeSac(j.x,j.y,c.nope,["anaconda"])&&(c.nope[j.x+"-"+j.y]=!0),c.entity.move(j.x,j.y)},c.init()},a.isCulDeSac=function(b,c,d,e){for(var e=e||[],d=d||[],f=4,g=[{x:b+1,y:c},{x:b-1,y:c},{x:b,y:c+1},{x:b,y:c-1}],h=0;h<g.length;h++){var i=a.getValue(g[h].x,g[h].y);(d[g[h].x+"-"+g[h].y]||i===!1||null!==i&&"object"==typeof i&&-1==e.indexOf(i.name))&&f--}return 1>f},a.Anaconda=function(){var c=this;return c.parts=[],c.length=6,c.init=function(){for(var b={x:random_num(0,a.width/3,!0),y:random_num(2*(a.height/3),a.height,!0)},d=0;d<c.length;d++)c.parts.push(new a.Entity({name:"anaconda",container:"anaconda","class":"stickman "+(0==d?"head":d==c.length-1?"butt":"segment"),x:b.x,y:b.y}));return c},c.move=function(){for(var b=null,d=0;d<c.parts.length;d++){var e=c.parts[d];if(0==d){b={x:e.x,y:e.y};var f=e.x+a.directions[a.direction].x,g=e.y+a.directions[a.direction].y;if(e.direction=a.getDirection(b,{x:f,y:g}),0!=d||null!==a.getValue(f,g)){var h=a.getValue(f,g);"object"==typeof h&&h.name&&"victim"==h.name?a.win():a.direction=a.lastdirection;break}e.$cell.attr("lookat",a.direction),e.move(f,g),a.lastdirection=a.direction}else{var i={x:b.x,y:b.y};b={x:e.x,y:e.y},e.direction=a.getDirection(b,i),e.move(i.x,i.y)}}for(var d=0;d<c.parts.length;d++){var e=c.parts[d],j="";j+=e.direction,c.parts[d-1]&&c.parts[d-1].direction!=e.direction&&(j+=c.parts[d-1].direction),d==c.parts.length-1&&c.parts[d-1]&&c.parts[d-1].direction!=e.direction&&(j=c.parts[d-1].direction),e.$cell.attr("lookat",j)}a.isCulDeSac(c.parts[0].x,c.parts[0].y,null,["victim"])&&a.lose()},c.init()},a.getDirection=function(a,b){return a.x>b.x?"left":a.x<b.x?"right":a.y<b.y?"bottom":a.y>b.y?"top":void 0},a.render=function(){a.started&&(a.frames++,a.victim.move(),a.anaconda.move())},a.init()}();